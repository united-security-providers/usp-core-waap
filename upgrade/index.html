
<!DOCTYPE html>

<html class="no-js" lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<link href="../helm-values/" rel="prev"/>
<link href="../logs-metrics/" rel="next"/>
<link href="../assets/images/favicon.png" rel="icon"/>
<meta content="mkdocs-1.5.2, mkdocs-material-9.2.3" name="generator"/>
<title>Core WAAP Upgrade - USP Core WAAP documentation</title>
<link href="../assets/stylesheets/main.0e669242.min.css" rel="stylesheet"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&amp;display=fallback" rel="stylesheet"/>
<style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
<link href="../assets/stylesheets/extra.css" rel="stylesheet"/>
<script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
</head>
<body dir="ltr">
<script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
<input autocomplete="off" class="md-toggle" data-md-toggle="drawer" id="__drawer" type="checkbox"/>
<input autocomplete="off" class="md-toggle" data-md-toggle="search" id="__search" type="checkbox"/>
<label class="md-overlay" for="__drawer"></label>
<div data-md-component="skip">
<a class="md-skip" href="#updating-core-waap-operator">
          Skip to content
        </a>
</div>
<div data-md-component="announce">
</div>
<header class="md-header md-header--shadow" data-md-component="header">
<nav aria-label="Header" class="md-header__inner md-grid">
<a aria-label="USP Core WAAP documentation" class="md-header__button md-logo" data-md-component="logo" href=".." title="USP Core WAAP documentation">
<img alt="logo" src="../assets/images/USP-Logo-2023-ohne-claim-lang-white1.webp"/>
</a>
<label class="md-header__button md-icon" for="__drawer">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"></path></svg>
</label>
<div class="md-header__title" data-md-component="header-title">
<div class="md-header__ellipsis">
<div class="md-header__topic">
<span class="md-ellipsis">
            USP Core WAAP documentation
          </span>
</div>
<div class="md-header__topic" data-md-component="header-topic">
<span class="md-ellipsis">
            
              Core WAAP Upgrade
            
          </span>
</div>
</div>
</div>
<label class="md-header__button md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"></path></svg>
</label>
<div class="md-search" data-md-component="search" role="dialog">
<label class="md-search__overlay" for="__search"></label>
<div class="md-search__inner" role="search">
<form class="md-search__form" name="search">
<input aria-label="Search" autocapitalize="off" autocomplete="off" autocorrect="off" class="md-search__input" data-md-component="search-query" name="query" placeholder="Search" required="" spellcheck="false" type="text"/>
<label class="md-search__icon md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"></path></svg>
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"></path></svg>
</label>
<nav aria-label="Search" class="md-search__options">
<button aria-label="Clear" class="md-search__icon md-icon" tabindex="-1" title="Clear" type="reset">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"></path></svg>
</button>
</nav>
</form>
<div class="md-search__output">
<div class="md-search__scrollwrap" data-md-scrollfix="">
<div class="md-search-result" data-md-component="search-result">
<div class="md-search-result__meta">
            Initializing search
          </div>
<ol class="md-search-result__list" role="presentation"></ol>
</div>
</div>
</div>
</div>
</div>
</nav>
</header>
<div class="md-container" data-md-component="container">
<main class="md-main" data-md-component="main">
<div class="md-main__inner md-grid">
<div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Navigation" class="md-nav md-nav--primary" data-md-level="0">
<label class="md-nav__title" for="__drawer">
<a aria-label="USP Core WAAP documentation" class="md-nav__button md-logo" data-md-component="logo" href=".." title="USP Core WAAP documentation">
<img alt="logo" src="../assets/images/USP-Logo-2023-ohne-claim-lang-white1.webp"/>
</a>
    USP Core WAAP documentation
  </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="..">
<span class="md-ellipsis">
    Welcome
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_2" type="checkbox"/>
<label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
<span class="md-ellipsis">
    Release Notes
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_2_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_2">
<span class="md-nav__icon md-icon"></span>
            Release Notes
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../waap-CHANGELOG/">
<span class="md-ellipsis">
    Core WAAP
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../operator-CHANGELOG/">
<span class="md-ellipsis">
    Operator
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../helm-CHANGELOG/">
<span class="md-ellipsis">
    Helm Chart
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_3" type="checkbox"/>
<label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
<span class="md-ellipsis">
    Configuration
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_3_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_3">
<span class="md-nav__icon md-icon"></span>
            Configuration
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../crd-doc/">
<span class="md-ellipsis">
    Custom Resource
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../error-pages-static-files/">
<span class="md-ellipsis">
    Error Pages / Static Files
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../native-config-post-processing/">
<span class="md-ellipsis">
    Native Config Post-Processing
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--active md-nav__item--nested">
<input checked="" class="md-nav__toggle md-toggle" id="__nav_4" type="checkbox"/>
<label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
<span class="md-ellipsis">
    Operation
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="true" aria-labelledby="__nav_4_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_4">
<span class="md-nav__icon md-icon"></span>
            Operation
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_4_1" type="checkbox"/>
<label class="md-nav__link" for="__nav_4_1" id="__nav_4_1_label" tabindex="0">
<span class="md-ellipsis">
    Operator helm chart
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_4_1_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_4_1">
<span class="md-nav__icon md-icon"></span>
            Operator helm chart
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../helm/">
<span class="md-ellipsis">
    Usage
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../helm-values/">
<span class="md-ellipsis">
    Values
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--active">
<input class="md-nav__toggle md-toggle" id="__toc" type="checkbox"/>
<label class="md-nav__link md-nav__link--active" for="__toc">
<span class="md-ellipsis">
    Core WAAP Upgrade
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<a class="md-nav__link md-nav__link--active" href="./">
<span class="md-ellipsis">
    Core WAAP Upgrade
  </span>
</a>
<nav aria-label="Table of contents" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#core-waap-migration-guide">
    Core WAAP Migration Guide
  </a>
<nav aria-label="Core WAAP Migration Guide" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#core-waap-operator-080-to-100">
    Core WAAP Operator 0.8.0 to 1.0.0
  </a>
<nav aria-label="Core WAAP Operator 0.8.0 to 1.0.0" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#operation-related-settings">
    Operation-related settings
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#crs-rules-are-now-enums">
    CRS rules are now enums
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#general">
    General
  </a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../logs-metrics/">
<span class="md-ellipsis">
    Logs and metrics
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../autolearning/">
<span class="md-ellipsis">
    Auto-Learning
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../downloads/">
<span class="md-ellipsis">
    Downloads
  </span>
</a>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Table of contents" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#core-waap-migration-guide">
    Core WAAP Migration Guide
  </a>
<nav aria-label="Core WAAP Migration Guide" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#core-waap-operator-080-to-100">
    Core WAAP Operator 0.8.0 to 1.0.0
  </a>
<nav aria-label="Core WAAP Operator 0.8.0 to 1.0.0" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#operation-related-settings">
    Operation-related settings
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#crs-rules-are-now-enums">
    CRS rules are now enums
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#general">
    General
  </a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-content" data-md-component="content">
<article class="md-content__inner md-typeset">
<h1 id="updating-core-waap-operator">Updating Core WAAP Operator</h1>
<p>To run a newer version of the Core WAAP Operator the corresponding helm chart can be used. Please check in the release notes what has changed and which settings may affect your deployed CoreWaapServices. In case of breaking changes, it is recommended to follow these instructions:</p>
<ol>
<li>Stop the Core WAAP Operator by scaling the deployment down to 0 replicas.</li>
<li>Update the Core WAAP Operator by installing the new helm chart (ensure the CoreWaapService CustomResourceDefinition was updated.)</li>
<li>Align the CoreWaapServices with the new schema according to the breaking changes in the release notes.</li>
<li>Scale up the Core WAAP Operator deployment to 1 replica.</li>
<li>Check the Core WAAP Operator Logs, to ensure that no error due to incompatibility occurs. Fix the remaining issues in the CoreWaapServices Custom Resources if required.</li>
</ol>
<p><strong>Note:</strong> This procedure should prevent any downtime of a CoreWaapService. In case also a new Core WAAP Version is set, the pods will restart accordingly.</p>
<h2 id="core-waap-migration-guide">Core WAAP Migration Guide</h2>
<h3 id="core-waap-operator-080-to-100">Core WAAP Operator 0.8.0 to 1.0.0</h3>
<h4 id="operation-related-settings">Operation-related settings</h4>
<p>The following kinds of settings have been regularized:</p>
<ul>
<li>Instead of using annotations, use settings in the CoreWaapService CR under <code>spec.operation</code>.<br/>
<strong>Note:</strong> This means that all Core WAAP annotations have to be removed during migration.</li>
<li>The exact same settings can also be provided as defaults in the operator helm chart under <code>config.coreWaapDefaults</code>, replacing a number of previous operator settings.<br/>
<strong>Note:</strong> All previous settings in the operator helm chart have to be moved to the new structure, even the ones that have no equivalent under <code>spec.operation</code>; best use the provided new helm chart as a basis.</li>
</ul>
<p>Generally, see the CoreWaapService CRD under <code>spec.operation</code> for all possible settings.</p>
<p>Migration setting-by-setting:</p>
<ul>
<li>operator <code>envoy.image</code> / annotation <code>image</code> =&gt; <code>*.image</code><br/>
  (where <code>*.image</code> stands for <code>spec.operation.image</code> in the CoreWaapService CR, plus default in the operator helm chart at <code>config.coreWaapDefaults.image</code>, and similary in the following lines)</li>
<li>annotations <code>version</code> and <code>registry</code> =&gt; no longer supported, specify in <code>*.image</code></li>
<li>operator <code>envoy.labels</code> / annotation <code>labels</code> =&gt; <code>*.labels</code> (key/value)</li>
<li>operator <code>serviceAnnotations</code> / annotation <code>service-annotations</code> =&gt; <code>*.serviceAnnotations</code> (key/value)</li>
<li>operator <code>envoy.servicePort</code> and <code>envoy.listenerPort</code> / annotation <code>service-port</code> and <code>listener-port</code> =&gt; <code>*.port</code> (can no longer be set to different values, no use case)</li>
<li>operator <code>envoy.serviceAdminPort</code> and <code>envoy.listenerAdminPort</code> / annotation <code>admin-service-port</code> and <code>admin-listener-port</code> =&gt; <code>*.adminInterfaceService.port</code> (can also no longer be set to different values, no use case)</li>
<li><code>envoy.replicas</code> / annotation <code>replicas</code> =&gt; <code>*.replicas</code></li>
<li>operator <code>envoy.resources.*</code> / annotations <code>request-cpu</code>, <code>request-memory</code>, <code>limits-cpu</code>, <code>limits-memory</code> =&gt; <code>*.respources</code> (standard Kubernetes format; note that <code>request</code> in the old settings was wrong, in Kubernetes is plural <code>requests</code>)</li>
<li>operator <code>operator.caCertificatesConfigMapName</code> / annotation <code>custom-cacerts</code> =&gt; <code>*.caCertificates.configMap</code></li>
<li>operator <code>operator.caCertificateKeyInConfigMap</code> / annotation <code>custom-cacerts-key</code> =&gt; <code>*.caCertificates.key</code></li>
</ul>
<p>The setting <code>operator.watchedNamespaces</code> is now <code>config.watchedNamespaces</code>.</p>
<h4 id="crs-rules-are-now-enums">CRS rules are now enums</h4>
<ul>
<li>CRS request and response rules are no longer integers but enums, see the CRD for values.</li>
<li><strong>Note</strong>: Because the default for request rules has changed to all activated by default, if you previously had listed all of them, there is need to list them now all as enum values, just omit the setting.</li>
</ul>
<h4 id="general">General</h4>
<ul>
<li>See the breaking changes in the changelog. For example, some of the security features that have been activated by default (header filtering, CRS, CSRF) typically have no impact in practice, but legacy components might fail to pass through.</li>
</ul>
</article>
</div>
</div>
</main>
<footer class="md-footer">
<div class="md-footer-meta md-typeset">
<div class="md-footer-meta__inner md-grid">
<div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" rel="noopener" target="_blank">
      Material for MkDocs
    </a>
</div>
</div>
</div>
</footer>
</div>
<div class="md-dialog" data-md-component="dialog">
<div class="md-dialog__inner md-typeset"></div>
</div>
<script id="__config" type="application/json">{"base": "..", "features": [], "search": "../assets/javascripts/workers/search.dfff1995.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
<script src="../assets/javascripts/bundle.78eede0e.min.js"></script>
<script>document$.subscribe(() => {
            window.update_swagger_ui_iframe_height = function (id) {
                var iFrameID = document.getElementById(id);
                if (iFrameID) {
                    full_height = (iFrameID.contentWindow.document.body.scrollHeight + 80) + "px";
                    iFrameID.height = full_height;
                    iFrameID.style.height = full_height;
                }
            }
        
            let iframe_id_list = []
            var iframes = document.getElementsByClassName("swagger-ui-iframe");
            for (var i = 0; i < iframes.length; i++) { 
                iframe_id_list.push(iframes[i].getAttribute("id"))
            }
        
            let ticking = true;
            
            document.addEventListener('scroll', function(e) {
                if (!ticking) {
                    window.requestAnimationFrame(()=> {
                        let half_vh = window.innerHeight/2;
                        for(var i = 0; i < iframe_id_list.length; i++) {
                            let element = document.getElementById(iframe_id_list[i])
                            if(element==null){
                                return
                            }
                            let diff = element.getBoundingClientRect().top
                            if(element.contentWindow.update_top_val){
                                element.contentWindow.update_top_val(half_vh - diff)
                            }
                        }
                        ticking = false;
                    });
                    ticking = true;
                }
            });
        
            const dark_scheme_name = "slate"
            
            window.scheme = document.body.getAttribute("data-md-color-scheme")
            const options = {
                attributeFilter: ['data-md-color-scheme'],
            };
            function color_scheme_callback(mutations) {
                for (let mutation of mutations) {
                    if (mutation.attributeName === "data-md-color-scheme") {
                        scheme = document.body.getAttribute("data-md-color-scheme")
                        var iframe_list = document.getElementsByClassName("swagger-ui-iframe")
                        for(var i = 0; i < iframe_list.length; i++) {
                            var ele = iframe_list.item(i);
                            if (ele) {
                                if (scheme === dark_scheme_name) {
                                    ele.contentWindow.enable_dark_mode();
                                } else {
                                    ele.contentWindow.disable_dark_mode();
                                }
                            }
                        }
                    }
                }
            }
            observer = new MutationObserver(color_scheme_callback);
            observer.observe(document.body, options);
            })</script></body>
</html>