
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../error-mapping/">
      
      
        <link rel="next" href="../traffic-processing-overview/">
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.14">
    
    
      
        <title>Native Config Post-Processing - USP Core WAAP documentation</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.342714a4.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/extra.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#native-config-post-processing-ncpp" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="USP Core WAAP documentation" class="md-header__button md-logo" aria-label="USP Core WAAP documentation" data-md-component="logo">
      
  <img src="../assets/images/USP-Logo-2023-ohne-claim-lang-white1.webp" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            USP Core WAAP documentation
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Native Config Post-Processing
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="USP Core WAAP documentation" class="md-nav__button md-logo" aria-label="USP Core WAAP documentation" data-md-component="logo">
      
  <img src="../assets/images/USP-Logo-2023-ohne-claim-lang-white1.webp" alt="logo">

    </a>
    USP Core WAAP documentation
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Welcome
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Release Notes
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Release Notes
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../helm-CHANGELOG/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Helm Chart
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../operator-CHANGELOG/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Operator
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../waap-CHANGELOG/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Core WAAP
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ext-proc-icap-CHANGELOG/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    extProc ICAP
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ext-proc-openapi-CHANGELOG/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    extProc OpenAPI
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" checked>
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Configuration
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Configuration
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../crd-doc/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    API Reference
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../error-mapping/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Error Mapping
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    Native Config Post-Processing
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    Native Config Post-Processing
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#introduction" class="md-nav__link">
    <span class="md-ellipsis">
      Introduction
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#examples" class="md-nav__link">
    <span class="md-ellipsis">
      Examples
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Examples">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#example-file-upload-in-large-chunks" class="md-nav__link">
    <span class="md-ellipsis">
      Example: File upload in large chunks
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#general-comments" class="md-nav__link">
    <span class="md-ellipsis">
      General Comments
    </span>
  </a>
  
    <nav class="md-nav" aria-label="General Comments">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#use-cases-and-best-practices" class="md-nav__link">
    <span class="md-ellipsis">
      Use cases and best practices
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Use cases and best practices">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#quick-workarounds-for-issues-in-production" class="md-nav__link">
    <span class="md-ellipsis">
      Quick workarounds for issues in production
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#quick-and-flexible-integrations-of-something-new" class="md-nav__link">
    <span class="md-ellipsis">
      Quick and flexible integrations of something new
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tuning-debugging-existing-installations" class="md-nav__link">
    <span class="md-ellipsis">
      Tuning / debugging existing installations
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#future-improvements" class="md-nav__link">
    <span class="md-ellipsis">
      Future Improvements
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_4" >
        
          
          <label class="md-nav__link" for="__nav_3_4" id="__nav_3_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Traffic Processing
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_4">
            <span class="md-nav__icon md-icon"></span>
            Traffic Processing
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../traffic-processing-overview/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Overview
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../icap-antivirus-scanning/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ICAP Antivirus Scanning
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../openapi-validation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    OpenAPI Validation
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../crs-virtual-patch/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Virtual Patch
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lua-filters/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Lua Filters
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Operation
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Operation
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_1" >
        
          
          <label class="md-nav__link" for="__nav_4_1" id="__nav_4_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Operator Helm Chart
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_1">
            <span class="md-nav__icon md-icon"></span>
            Operator Helm Chart
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../helm/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Usage
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../helm-values/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Values
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../upgrade/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Core WAAP Upgrade
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../logs-metrics/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Logs and Metrics
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../autolearning/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Auto-Learning
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../large-payloads/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Large Payloads
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../downloads/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Downloads
    
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#introduction" class="md-nav__link">
    <span class="md-ellipsis">
      Introduction
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#examples" class="md-nav__link">
    <span class="md-ellipsis">
      Examples
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Examples">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#example-file-upload-in-large-chunks" class="md-nav__link">
    <span class="md-ellipsis">
      Example: File upload in large chunks
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#general-comments" class="md-nav__link">
    <span class="md-ellipsis">
      General Comments
    </span>
  </a>
  
    <nav class="md-nav" aria-label="General Comments">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#use-cases-and-best-practices" class="md-nav__link">
    <span class="md-ellipsis">
      Use cases and best practices
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Use cases and best practices">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#quick-workarounds-for-issues-in-production" class="md-nav__link">
    <span class="md-ellipsis">
      Quick workarounds for issues in production
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#quick-and-flexible-integrations-of-something-new" class="md-nav__link">
    <span class="md-ellipsis">
      Quick and flexible integrations of something new
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tuning-debugging-existing-installations" class="md-nav__link">
    <span class="md-ellipsis">
      Tuning / debugging existing installations
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#future-improvements" class="md-nav__link">
    <span class="md-ellipsis">
      Future Improvements
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  



<h1 id="native-config-post-processing-ncpp">Native Config Post-Processing (NCPP)</h1>
<p>This feature allows the use of all the underlying Envoy capabilities even if they are not (yet) configurable via the Core WAAP custom resource.</p>
<h2 id="introduction">Introduction</h2>
<p>The Core WAAP Operator translates the Core WAAP custom resource (CR) to native configuration of the Envoy proxy.
The resulting native configuration is also in the form of YAML files.</p>
<p>The "native configuration post-processing" feature allows to adapt the generated Envoy configuration before it is deployed, using JavaScript.
This allows to freely modify the effective configuration by adding, changing or removing arbitrary settings.</p>
<p>A very basic example to make the concept clear:
Below the beginning of the Envoy config file <code>envoy.yaml</code> as it is currently generated by default:</p>
<div class="highlight"><pre><span></span><code><span class="nt">node</span><span class="p">:</span>
<span class="w">  </span><span class="nt">id</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;core.waap.id&quot;</span>
<span class="w">  </span><span class="nt">cluster</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;core.waap.cluster&quot;</span>
<span class="c1"># ... more generated settings ...</span>
</code></pre></div>
<p>Suppose that for some reason you wanted to change the <code>id</code> to <code>core.waap.id.modified-by-post-processing</code> (not a practically useful example, just to explain the concept, more realistic examples further below).
Then you could configure the following in the <code>nativeConfigPostProcessing</code> section of the CR:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># ... other settings (routes, authentications, etc.) ...</span>

<span class="nt">nativeConfigPostProcessing</span><span class="p">:</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;envoy.node.id</span><span class="nv"> </span><span class="s">=</span><span class="nv"> </span><span class="s">&#39;core.waap.id.modified-by-post-processing&#39;&quot;</span>
</code></pre></div>
<p>The configured JavaScript gets a variable <code>envoy</code> at runtime that contains the parsed YAML content of <code>envoy.yaml</code>.
Hence <code>envoy.node.id</code> selects the node ID in the YAML tree structure and setting it to a different value overwrites the previous value.
The operator takes care of translating the JavaScript variables back to YAML files, i.e. in the end also generates an <code>envoy.yaml</code> that is then deployed:</p>
<div class="highlight"><pre><span></span><code><span class="nt">node</span><span class="p">:</span>
<span class="w">  </span><span class="nt">id</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;core.waap.id.modified-by-post-processing&quot;</span>
<span class="w">  </span><span class="nt">cluster</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;core.waap.cluster&quot;</span>
<span class="c1"># ... more generated settings ...</span>
</code></pre></div>
<p>Currently, three native Enovy YAML files and corresponding JavaScript variables are generated:</p>
<ul>
<li><code>envoy.yaml</code> (<code>envoy</code>): Root Envoy configuration with some basic settings, also references the two files below.</li>
<li><code>lds.yaml</code> (<code>lds</code>): Envoy listener configuration ("frontend"), incl. filter chains.</li>
<li><code>cds.yaml</code> (<code>cds</code>): Envoy cluster configuration ("backends").</li>
</ul>
<p>In the following a couple of real examples that were needed and worked at the time.
Note that they may not be needed or not work any more by the time you are reading this,
but they should be specific enough to show the possibilities.</p>
<p>After that, some general comments about use cases, best practices and potential future improvements.</p>
<h2 id="examples">Examples</h2>
<h3 id="example-file-upload-in-large-chunks">Example: File upload in large chunks</h3>
<p>By default, Envoy has a limit on uploads to chunks of maximally 1 MB when in combination with the Coraza filter (CRS enabled). This default behavior can be changed by explicitly setting <code>perConnectionBufferLimitBytes</code> on the listener, in the example below set to 10 MB in <code>lds.yaml</code>:</p>
<div class="highlight"><pre><span></span><code><span class="nt">resources</span><span class="p">:</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&#39;@type&#39;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="s">&quot;type.googleapis.com/envoy.config.listener.v3.Listener&quot;</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;core.waap.listener&quot;</span>
<span class="w">  </span><span class="nt">address</span><span class="p">:</span>
<span class="w">    </span><span class="nt">socketAddress</span><span class="p">:</span>
<span class="w">      </span><span class="nt">address</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;0.0.0.0&quot;</span>
<span class="w">      </span><span class="nt">portValue</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8080</span>
<span class="w">  </span><span class="nt">filterChains</span><span class="p">:</span>
<span class="w">  </span><span class="c1"># ... more config omitted ...</span>
<span class="w">  </span><span class="nt">perConnectionBufferLimitBytes</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10485760</span>
</code></pre></div>
<p>As of writing this, there is only a single listener resource in the <code>lds.yaml</code>, hence the native config post-processing can be written like this:</p>
<div class="highlight"><pre><span></span><code><span class="nt">nativeConfigPostProcessing</span><span class="p">:</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;lds.resources[0].perConnectionBufferLimitBytes</span><span class="nv"> </span><span class="s">=</span><span class="nv"> </span><span class="s">10485760&quot;</span>
</code></pre></div>
<h2 id="general-comments">General Comments</h2>
<h3 id="use-cases-and-best-practices">Use cases and best practices</h3>
<h4 id="quick-workarounds-for-issues-in-production">Quick workarounds for issues in production</h4>
<p>This allows to fix at least some imminent problems without the need to create a bugfix release immediately.</p>
<p>This can be especially useful in cases where a fix cannot be easily tested outside production, reducing turnaround times and thus a quicker fix in production.</p>
<p>Obviously, in most cases the idea is to afterward include a corresponding fix into the next regular Core WAAP release.</p>
<h4 id="quick-and-flexible-integrations-of-something-new">Quick and flexible integrations of something new</h4>
<p>A PoC is maybe the most general example for this use case, where integration issues can be solved ad-hoc whenever they occur without immediate need for a release, again also reducing turnaround times in cases where the feature cannot be easily/immediately tested outside the environment of the customer.</p>
<p>Depending on the nature of the integration, it may later make sense to include new features into the Core WAAP that cover the new integrations, namely if the integrations are of a kind that is generally useful, or are the better choice for other reasons.</p>
<p>Side remark: Note that this use case is often also interesting internally at USP because it allows to explore new settings sometimes more quickly than operating directly with native Envoy config.</p>
<h4 id="tuning-debugging-existing-installations">Tuning / debugging existing installations</h4>
<p>Use features that are present in the underlying Envoy but not (yet) configurable via the Core WAAP custom resource.</p>
<h3 id="future-improvements">Future Improvements</h3>
<p>We are evaluating various ways to make using this feature generally more easy and also more robust regarding new Core WAAP releases.</p>
<p><em>Note that the generated native Envoy config is subject to change:</em></p>
<p>Its structure may change, due to changes in the Core WAAP Operator or also due to changes in the underlying Envoy itself, hence it is not an API that is in any way guaranteed to remain stable, while in practice many things will still be quite stable most of the time.</p>
<p>As an example of potential future enhancements, JavaScript functions may be offered to get/set the Core Rule Set (CRS) settings of the Coraza filter more easily.
And/or similar JavaScript functions that make it both more simple and potentially also more robust to get/set some specific or general items in the native Envoy config.</p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "..", "features": [], "search": "../assets/javascripts/workers/search.d50fe291.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../assets/javascripts/bundle.13a4f30d.min.js"></script>
      
    
  </body>
</html>