
<!DOCTYPE html>

<html class="no-js" lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<link href="../crs-virtual-patch/" rel="prev"/>
<link href="../helm/" rel="next"/>
<link href="../assets/images/favicon.png" rel="icon"/>
<meta content="mkdocs-1.6.1, mkdocs-material-9.6.3" name="generator"/>
<title>Lua Filters - USP Core WAAP documentation</title>
<link href="../assets/stylesheets/main.d7758b05.min.css" rel="stylesheet"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&amp;display=fallback" rel="stylesheet"/>
<style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
<link href="../assets/stylesheets/extra.css" rel="stylesheet"/>
<script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
</head>
<body dir="ltr">
<input autocomplete="off" class="md-toggle" data-md-toggle="drawer" id="__drawer" type="checkbox"/>
<input autocomplete="off" class="md-toggle" data-md-toggle="search" id="__search" type="checkbox"/>
<label class="md-overlay" for="__drawer"></label>
<div data-md-component="skip">
<a class="md-skip" href="#lua-filters">
          Skip to content
        </a>
</div>
<div data-md-component="announce">
</div>
<header class="md-header md-header--shadow" data-md-component="header">
<nav aria-label="Header" class="md-header__inner md-grid">
<a aria-label="USP Core WAAP documentation" class="md-header__button md-logo" data-md-component="logo" href=".." title="USP Core WAAP documentation">
<img alt="logo" src="../assets/images/USP-Logo-2023-ohne-claim-lang-white1.webp"/>
</a>
<label class="md-header__button md-icon" for="__drawer">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"></path></svg>
</label>
<div class="md-header__title" data-md-component="header-title">
<div class="md-header__ellipsis">
<div class="md-header__topic">
<span class="md-ellipsis">
            USP Core WAAP documentation
          </span>
</div>
<div class="md-header__topic" data-md-component="header-topic">
<span class="md-ellipsis">
            
              Lua Filters
            
          </span>
</div>
</div>
</div>
<script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
<label class="md-header__button md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg>
</label>
<div class="md-search" data-md-component="search" role="dialog">
<label class="md-search__overlay" for="__search"></label>
<div class="md-search__inner" role="search">
<form class="md-search__form" name="search">
<input aria-label="Search" autocapitalize="off" autocomplete="off" autocorrect="off" class="md-search__input" data-md-component="search-query" name="query" placeholder="Search" required="" spellcheck="false" type="text"/>
<label class="md-search__icon md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg>
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"></path></svg>
</label>
<nav aria-label="Search" class="md-search__options">
<button aria-label="Clear" class="md-search__icon md-icon" tabindex="-1" title="Clear" type="reset">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path></svg>
</button>
</nav>
</form>
<div class="md-search__output">
<div class="md-search__scrollwrap" data-md-scrollfix="" tabindex="0">
<div class="md-search-result" data-md-component="search-result">
<div class="md-search-result__meta">
            Initializing search
          </div>
<ol class="md-search-result__list" role="presentation"></ol>
</div>
</div>
</div>
</div>
</div>
</nav>
</header>
<div class="md-container" data-md-component="container">
<main class="md-main" data-md-component="main">
<div class="md-main__inner md-grid">
<div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Navigation" class="md-nav md-nav--primary" data-md-level="0">
<label class="md-nav__title" for="__drawer">
<a aria-label="USP Core WAAP documentation" class="md-nav__button md-logo" data-md-component="logo" href=".." title="USP Core WAAP documentation">
<img alt="logo" src="../assets/images/USP-Logo-2023-ohne-claim-lang-white1.webp"/>
</a>
    USP Core WAAP documentation
  </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="..">
<span class="md-ellipsis">
    Welcome
    
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_2" type="checkbox"/>
<label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
<span class="md-ellipsis">
    Release Notes
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_2_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_2">
<span class="md-nav__icon md-icon"></span>
            Release Notes
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../helm-CHANGELOG/">
<span class="md-ellipsis">
    Helm Chart
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../operator-CHANGELOG/">
<span class="md-ellipsis">
    Operator
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../waap-CHANGELOG/">
<span class="md-ellipsis">
    Core WAAP
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../ext-proc-icap-CHANGELOG/">
<span class="md-ellipsis">
    extProc ICAP
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../ext-proc-openapi-CHANGELOG/">
<span class="md-ellipsis">
    extProc OpenAPI
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--active md-nav__item--nested">
<input checked="" class="md-nav__toggle md-toggle" id="__nav_3" type="checkbox"/>
<label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
<span class="md-ellipsis">
    Configuration
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="true" aria-labelledby="__nav_3_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_3">
<span class="md-nav__icon md-icon"></span>
            Configuration
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../crd-doc/">
<span class="md-ellipsis">
    API Reference
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../error-mapping/">
<span class="md-ellipsis">
    Error Mapping
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../native-config-post-processing/">
<span class="md-ellipsis">
    Native Config Post-Processing
    
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_3_4" type="checkbox"/>
<label class="md-nav__link" for="__nav_3_4" id="__nav_3_4_label" tabindex="0">
<span class="md-ellipsis">
    Traffic Processing
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_3_4_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_3_4">
<span class="md-nav__icon md-icon"></span>
            Traffic Processing
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../traffic-processing-overview/">
<span class="md-ellipsis">
    Overview
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../icap-antivirus-scanning/">
<span class="md-ellipsis">
    ICAP Antivirus Scanning
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../openapi-validation/">
<span class="md-ellipsis">
    OpenAPI Validation
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../crs-virtual-patch/">
<span class="md-ellipsis">
    Virtual Patch
    
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--active">
<input class="md-nav__toggle md-toggle" id="__toc" type="checkbox"/>
<label class="md-nav__link md-nav__link--active" for="__toc">
<span class="md-ellipsis">
    Lua Filters
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<a class="md-nav__link md-nav__link--active" href="./">
<span class="md-ellipsis">
    Lua Filters
    
  </span>
</a>
<nav aria-label="Table of contents" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#example-1-multiple-filters-store-path-simple-lua-module">
<span class="md-ellipsis">
      Example 1: Multiple filters, store path, simple Lua module
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#example-2-share-data-between-filters-in-same-request">
<span class="md-ellipsis">
      Example 2: Share data between filters in same request
    </span>
</a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_4" type="checkbox"/>
<label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
<span class="md-ellipsis">
    Operation
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_4_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_4">
<span class="md-nav__icon md-icon"></span>
            Operation
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_4_1" type="checkbox"/>
<label class="md-nav__link" for="__nav_4_1" id="__nav_4_1_label" tabindex="0">
<span class="md-ellipsis">
    Operator Helm Chart
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_4_1_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_4_1">
<span class="md-nav__icon md-icon"></span>
            Operator Helm Chart
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../helm/">
<span class="md-ellipsis">
    Usage
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../helm-values/">
<span class="md-ellipsis">
    Values
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../upgrade/">
<span class="md-ellipsis">
    Core WAAP Upgrade
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../logs-metrics/">
<span class="md-ellipsis">
    Logs and Metrics
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../autolearning/">
<span class="md-ellipsis">
    Auto-Learning
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../downloads/">
<span class="md-ellipsis">
    Downloads
    
  </span>
</a>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Table of contents" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#example-1-multiple-filters-store-path-simple-lua-module">
<span class="md-ellipsis">
      Example 1: Multiple filters, store path, simple Lua module
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#example-2-share-data-between-filters-in-same-request">
<span class="md-ellipsis">
      Example 2: Share data between filters in same request
    </span>
</a>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-content" data-md-component="content">
<article class="md-content__inner md-typeset">
<h1 id="lua-filters">Lua Filters</h1>
<p>Using Lua filters in the USP Core WAAP adds flexibility for custom application integrations.</p>
<p>Filters written in the <a href="https://www.lua.org/">Lua programming language</a> can be configured to be processed
as part of the regular request/response processing in the USP Core WAAP,
both before and after other filters (like filters for authentication, traffic processing, etc.).</p>
<p>Since the corresponding filter scripts are part of the configuration
of the USP Core WAAP — as opposed to part of a USP Core WAAP binary or release —,
this feature generally adds more flexibility with usually no significant performance impact.
(Lua is a very performant and sophisticated script language with a tiny footprint,
also broadly used in computer games for the same reasons,
and in the case of USP Core WAAP also precompiled with the Lua JIT compiler.)</p>
<p>The Envoy Lua filter usage, including what can be done in filter scripts, is generally described here:</p>
<ul>
<li><a href="https://www.envoyproxy.io/docs/envoy/latest/configuration/http/http_filters/lua_filter">envoy/Configuration reference/HTTP/HTTP filters/Lua</a></li>
</ul>
<p>The following examples show how to configure and use Lua filtering in the USP Core WAAP,
and provide at the same time some general info and tips regarding how to typically use Lua filters.</p>
<h2 id="example-1-multiple-filters-store-path-simple-lua-module">Example 1: Multiple filters, store path, simple Lua module</h2>
<p>Here is the <code>routes</code> and <code>lua</code> configuration for this example:</p>
<div class="highlight"><pre><span></span><code><span class="w">  </span><span class="nt">routes</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">match</span><span class="p">:</span>
<span class="w">        </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="s">"/foo"</span>
<span class="w">        </span><span class="nt">pathType</span><span class="p">:</span><span class="w"> </span><span class="s">"PREFIX"</span>
<span class="w">      </span><span class="nt">backend</span><span class="p">:</span>
<span class="w">        </span><span class="nt">address</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">myhost</span>
<span class="w">        </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8443</span>
<span class="w">        </span><span class="nt">tls</span><span class="p">:</span>
<span class="w">          </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">      </span><span class="nt">luaRefs</span><span class="p">:</span>
<span class="w">        </span><span class="nt">first</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">filter1.lua</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">filter2.lua</span>
<span class="w">        </span><span class="nt">last</span><span class="p">:</span>
<span class="w">          </span><span class="c1"># effective order will be reversed, will be the order at spec.lua</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">filter3.lua</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">filter2.lua</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">match</span><span class="p">:</span>
<span class="w">        </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="s">"/bar"</span>
<span class="w">        </span><span class="nt">pathType</span><span class="p">:</span><span class="w"> </span><span class="s">"PREFIX"</span>
<span class="w">      </span><span class="nt">backend</span><span class="p">:</span>
<span class="w">        </span><span class="nt">address</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">myhost</span>
<span class="w">        </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8443</span>
<span class="w">        </span><span class="nt">tls</span><span class="p">:</span>
<span class="w">          </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">      </span><span class="nt">luaRefs</span><span class="p">:</span>
<span class="w">        </span><span class="nt">first</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">filter1.lua</span>
<span class="w">  </span><span class="nt">lua</span><span class="p">:</span>
<span class="w">    </span><span class="nt">configMap</span><span class="p">:</span><span class="w"> </span><span class="s">"lua-basic-config-map"</span>
<span class="w">    </span><span class="nt">filters</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">filter1.lua</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">filter2.lua</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">filter3.lua</span>
<span class="w">    </span><span class="nt">helpers</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">util.lua</span>
</code></pre></div>
<p>There are two locations:</p>
<ul>
<li><code>/foo</code><ul>
<li><code>filter1</code> and <code>filter2</code> referenced as "first" Lua filters
  will be run in that order before all other filters
  (authentication, traffic processing, "last" Lua filters)</li>
<li><code>filter3</code> and <code>filter2</code> referenced as "last" Lua filters
  will be run in the order <code>filter2</code> then <code>filter3</code> after all other filters
  (except the final filter that routes to the backend)</li>
<li><strong>Note</strong> that the order in which filters are run is the order listed at <code>spec.lua</code>,
  not the order listed at <code>spec.routes.luaRefs.first|last</code>;
  this is essentially an architectural limitation of the underlying Envoy proxy.</li>
</ul>
</li>
<li><code>/bar</code><ul>
<li>Just <code>filter1</code> will be run as first filter.</li>
</ul>
</li>
</ul>
<p>The Lua filter and helper scripts are defined in a config map named <code>lua-basic-config-map</code>.
They only do some logging but do not modify request/response in this example. 
Besides the simple example in filter1.lua, filter2.lua and filter3.lua illustrate how utility functions from other scripts can be used (Lua module).</p>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ConfigMap</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s">"lua-basic-functionality-config-map"</span>
<span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{{</span><span class="nv">.Values.namespace</span><span class="p p-Indicator">}}</span>
<span class="nt">data</span><span class="p">:</span>
<span class="w">  </span><span class="nt">filter1.lua</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">    </span><span class="no">local path</span>
<span class="w">    </span><span class="no">function envoy_on_request(request_handle)</span>
<span class="w">        </span><span class="no">path = request_handle:headers():get(':path')</span>
<span class="w">        </span><span class="no">request_handle:logInfo('[REQ] ' .. path .. ' filter1')</span>
<span class="w">    </span><span class="no">end</span>
<span class="w">    </span><span class="no">function envoy_on_response(response_handle)</span>
<span class="w">        </span><span class="no">response_handle:logInfo('[RES] ' .. path .. ' filter1')</span>
<span class="w">    </span><span class="no">end</span>
<span class="w">  </span><span class="nt">filter2.lua</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">    </span><span class="no">local util = require 'opt.usp.core-waap.lua.filters.util'</span>
<span class="w">    </span><span class="no">local path</span>
<span class="w">    </span><span class="no">function envoy_on_request(request_handle)</span>
<span class="w">        </span><span class="no">path = util.getPath(request_handle)</span>
<span class="w">        </span><span class="no">util.logFilter(request_handle, 'REQ', path, 'filter2')</span>
<span class="w">    </span><span class="no">end</span>
<span class="w">    </span><span class="no">function envoy_on_response(response_handle)</span>
<span class="w">        </span><span class="no">util.logFilter(response_handle, 'RES', path, 'filter2')</span>
<span class="w">    </span><span class="no">end</span>
<span class="w">  </span><span class="nt">filter3.lua</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">    </span><span class="no">local util = require 'opt.usp.core-waap.lua.filters.util'</span>
<span class="w">    </span><span class="no">local path</span>
<span class="w">    </span><span class="no">function envoy_on_request(request_handle)</span>
<span class="w">        </span><span class="no">path = util.getPath(request_handle)</span>
<span class="w">        </span><span class="no">util.logFilter(request_handle, 'REQ', path, 'filter3')</span>
<span class="w">    </span><span class="no">end</span>
<span class="w">    </span><span class="no">function envoy_on_response(response_handle)</span>
<span class="w">        </span><span class="no">util.logFilter(response_handle, 'RES', path, 'filter3')</span>
<span class="w">    </span><span class="no">end</span>
<span class="w">  </span><span class="nt">util.lua</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">    </span><span class="no">local meta = { }</span>

<span class="w">    </span><span class="no">-- get path from request</span>
<span class="w">    </span><span class="no">function getPath(request_handle)</span>
<span class="w">        </span><span class="no">return request_handle:headers():get(':path')</span>
<span class="w">    </span><span class="no">end</span>
<span class="w">    </span><span class="no">meta.getPath = getPath</span>

<span class="w">    </span><span class="no">-- log direction, path and filter name as given</span>
<span class="w">    </span><span class="no">function logFilter(handle, direction, path, filter)</span>
<span class="w">      </span><span class="no">handle:logInfo('[' .. direction .. '] ' .. path .. ' ' .. filter)</span>
<span class="w">    </span><span class="no">end</span>
<span class="w">    </span><span class="no">meta.logFilter = logFilter</span>

<span class="w">    </span><span class="no">return meta</span>
</code></pre></div>
<p>Some things worth noting:</p>
<ul>
<li>The local variable <code>path</code> that is defined outside the two handlers for request and response
  is set in the request handler and available that way also in the response handler.</li>
<li>Both local and global variables defined that way are not available
  to other filter scripts nor to the same filter when processing a different request/response.</li>
<li>Lua filters and helper files (which are not limited to Lua scripts) are all deployed to the
  directory <code>/opt/usp/core-waap/lua/filters</code>.<ul>
<li>To use a helper Lua script e.g. <code>util.lua</code> that implements a Lua module use <code>require</code>
  as in the scripts above with module path of <code>opt.usp.core-waap.lua.filters.util</code>,
  which resolves to the Lua file at <code>/opt/usp/core-waap/lua/filters/util.lua</code>.</li>
<li>To read the contents of a helper file e.g. <code>config.xml</code> use the full path in Lua scripts,
  <code>/opt/usp/core-waap/lua/filters/config.xml</code>.</li>
</ul>
</li>
</ul>
<p>This produces the following log entries for a GET request first to <code>/foo</code> and then one to <code>/bar</code>
(log prefixes removed below):</p>
<div class="highlight"><pre><span></span><code>[REQ] /foo filter1
[REQ] /foo filter2
[REQ] /foo filter2
[REQ] /foo filter3
[RES] /foo filter3
[RES] /foo filter2
[RES] /foo filter2
[RES] /foo filter1
[REQ] /bar filter1
[RES] /bar filter1
</code></pre></div>
<p>Note that filters that come first when processing the request come last when processing the response.</p>
<h2 id="example-2-share-data-between-filters-in-same-request">Example 2: Share data between filters in same request</h2>
<p>Sometimes it is helpful to be able to share some data between filters,
for example  if some data that can only be obtained in a "first" filter
is needed in a "last" filter.</p>
<p>The underlying mechanism is called "dynamic metadata" in Envoy.</p>
<p>Here is a <code>util.lua</code> Lua module that would be defined as a helper script
in the USP Core WAAP configuration (see example 1 above):</p>
<div class="highlight"><pre><span></span><code><span class="kd">local</span><span class="w"> </span><span class="nv">meta</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">}</span>

<span class="c1">-- store given value under given key in given context</span>
<span class="kr">function</span><span class="w"> </span><span class="nf">set</span><span class="p">(</span><span class="nv">handle</span><span class="p">,</span><span class="w"> </span><span class="nv">contextId</span><span class="p">,</span><span class="w"> </span><span class="nv">key</span><span class="p">,</span><span class="w"> </span><span class="nv">value</span><span class="p">)</span>
<span class="w">    </span><span class="nv">handle</span><span class="p">:</span><span class="nf">streamInfo</span><span class="p">():</span><span class="nf">dynamicMetadata</span><span class="p">():</span><span class="nf">set</span><span class="p">(</span><span class="nv">contextId</span><span class="p">,</span><span class="w"> </span><span class="nv">key</span><span class="p">,</span><span class="w"> </span><span class="nv">value</span><span class="p">)</span>
<span class="kr">end</span>
<span class="nv">meta</span><span class="p">.</span><span class="py">set</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">set</span>

<span class="c1">-- retrieve given value under given key from given context</span>
<span class="kr">function</span><span class="w"> </span><span class="nf">get</span><span class="p">(</span><span class="nv">handle</span><span class="p">,</span><span class="w"> </span><span class="nv">contextId</span><span class="p">,</span><span class="w"> </span><span class="nv">key</span><span class="p">)</span>
<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">context</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">handle</span><span class="p">:</span><span class="nf">streamInfo</span><span class="p">():</span><span class="nf">dynamicMetadata</span><span class="p">():</span><span class="nf">get</span><span class="p">(</span><span class="nv">contextId</span><span class="p">)</span>
<span class="w">    </span><span class="kr">if</span><span class="w"> </span><span class="nv">context</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="kr">then</span>
<span class="w">        </span><span class="kr">return</span><span class="w"> </span><span class="kc">nil</span>
<span class="w">    </span><span class="kr">else</span>
<span class="w">        </span><span class="kr">return</span><span class="w"> </span><span class="nv">context</span><span class="p">[</span><span class="nv">key</span><span class="p">]</span>
<span class="w">    </span><span class="kr">end</span>
<span class="kr">end</span>
<span class="nv">meta</span><span class="p">.</span><span class="py">get</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">get</span>

<span class="kr">return</span><span class="w"> </span><span class="nv">meta</span>
</code></pre></div>
<p>The module would be used as in example 1, i.e. first required like this:</p>
<p><div class="highlight"><pre><span></span><code><span class="kd">local</span><span class="w"> </span><span class="nv">util</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">require</span><span class="w"> </span><span class="s1">'opt.usp.core-waap.lua.filters.util'</span>
</code></pre></div>
Then it could be used in filter request and response handlers in the following way,
where <code>handle</code> could be both a request or response handle.</p>
<p>Store value <code>myValue</code> with key <code>myKey</code> in shared context with id <code>contextId</code>:</p>
<div class="highlight"><pre><span></span><code><span class="nv">util</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="nv">handle</span><span class="p">,</span><span class="w"> </span><span class="s1">'contextId'</span><span class="p">,</span><span class="w"> </span><span class="s1">'myKey'</span><span class="p">,</span><span class="w"> </span><span class="s1">'myValue'</span><span class="p">)</span>
</code></pre></div>
<p>Retrieve value with key <code>myKey</code> from shared context with id <code>contextId</code>:</p>
<div class="highlight"><pre><span></span><code><span class="kd">local</span><span class="w"> </span><span class="nv">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">util</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="nv">handle</span><span class="p">,</span><span class="w"> </span><span class="s1">'contextId'</span><span class="p">,</span><span class="w"> </span><span class="s1">'myKey'</span><span class="p">)</span>
</code></pre></div>
<p>Note that this data is stored exclusively per single request/response transaction.
Other requests have no access to "dynamic metadata" of another request.</p>
</article>
</div>
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
</div>
</main>
<footer class="md-footer">
<div class="md-footer-meta md-typeset">
<div class="md-footer-meta__inner md-grid">
<div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" rel="noopener" target="_blank">
      Material for MkDocs
    </a>
</div>
</div>
</div>
</footer>
</div>
<div class="md-dialog" data-md-component="dialog">
<div class="md-dialog__inner md-typeset"></div>
</div>
<script id="__config" type="application/json">{"base": "..", "features": [], "search": "../assets/javascripts/workers/search.f8cc74c7.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
<script src="../assets/javascripts/bundle.f1b6f286.min.js"></script>
<script>document$.subscribe(() => {
            window.update_swagger_ui_iframe_height = function (id) {
                var iFrameID = document.getElementById(id);
                if (iFrameID) {
                    full_height = (iFrameID.contentWindow.document.body.scrollHeight + 80) + "px";
                    iFrameID.height = full_height;
                    iFrameID.style.height = full_height;
                }
            }
        
            let iframe_id_list = []
            var iframes = document.getElementsByClassName("swagger-ui-iframe");
            for (var i = 0; i < iframes.length; i++) { 
                iframe_id_list.push(iframes[i].getAttribute("id"))
            }
        
            let ticking = true;
            
            document.addEventListener('scroll', function(e) {
                if (!ticking) {
                    window.requestAnimationFrame(()=> {
                        let half_vh = window.innerHeight/2;
                        for(var i = 0; i < iframe_id_list.length; i++) {
                            let element = document.getElementById(iframe_id_list[i])
                            if(element==null){
                                return
                            }
                            let diff = element.getBoundingClientRect().top
                            if(element.contentWindow.update_top_val){
                                element.contentWindow.update_top_val(half_vh - diff)
                            }
                        }
                        ticking = false;
                    });
                    ticking = true;
                }
            });
        
            const dark_scheme_name = "slate"
            
            window.scheme = document.body.getAttribute("data-md-color-scheme")
            const options = {
                attributeFilter: ['data-md-color-scheme'],
            };
            function color_scheme_callback(mutations) {
                for (let mutation of mutations) {
                    if (mutation.attributeName === "data-md-color-scheme") {
                        scheme = document.body.getAttribute("data-md-color-scheme")
                        var iframe_list = document.getElementsByClassName("swagger-ui-iframe")
                        for(var i = 0; i < iframe_list.length; i++) {
                            var ele = iframe_list.item(i);
                            if (ele) {
                                if (scheme === dark_scheme_name) {
                                    ele.contentWindow.enable_dark_mode();
                                } else {
                                    ele.contentWindow.disable_dark_mode();
                                }
                            }
                        }
                    }
                }
            }
            observer = new MutationObserver(color_scheme_callback);
            observer.observe(document.body, options);
            })</script></body>
</html>