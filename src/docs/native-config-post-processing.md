# Native Config Post-Processing

This feature is very helpful in essentially these two use cases:

* Quick workarounds for issues in production.
* Quick and flexible integrations of something new.

## Introduction

The Core WAAP Operator translates Core WAAP custom resources (CRs) to native configuration of the Enovy proxy. The resulting native configuration is also in form of YAML files.

The "Native configuration post-processing" feature allows to modify the generated Envoy configuration before it is deployed, using JavaScript. This allows to freely modify the effective configuration by adding, changing or removing arbitrary settings.

A very basic example to make the concept clear. This is the beginning of the file `envoy.yaml` as it is currently generated by default:

```yaml
node:
  id: "core.waap.id"
  cluster: "core.waap.cluster"
# ... more generated settings ...
```

Suppose that for some reason you wanted to change the `id` to `core.waap.id.modified-by-post-processing` (not a practically useful example, just to explain the concept, more realistic examples further below). Then you could configure the following in the `nativeConfigPostProcessing` section of the CR:

```yaml
# ... other settings (routes, authentications, etc.) ...

nativeConfigPostProcessing:
- "envoy.node.id = 'core.waap.id.modified-by-post-processing'"
```

The configured JavaScript gets a variable `envoy`  that contains the parsed YAML content of `envoy.yaml`. Hence `envoy.node.id` selects the node ID in the YAML tree structure and setting it to a different value overwrites the previous value. (The operator takes care of translating the JavaScript variables back to YAML files, i.e. in the end also generates an `envoy.yaml` that is then deployed.)

```yaml
node:
  id: "core.waap.id.modified-by-post-processing"
  cluster: "core.waap.cluster"
# ... more generated settings ...
```

Currently, three native Enovy YAML files and corresponding JavaScript variables are generated:

* `envoy.yaml` (`envoy`): Root Envoy configuration with some basic settings including (if configured) static secrets.
* `lds.yaml` (`lds`): Envoy listener configuration, incl. filter chains.
* `cds.yaml` (`cds`): Envoy cluster configuration ("backends").



